name: Update debthin indexes

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:
    inputs:
      force_recurate:
        description: "Re-run curation from popcon"
        type: boolean
        default: false

concurrency:
  group: update-indexes
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "$GPG_KEY_ID:6:" | gpg --import-ownertrust

      - name: Re-curate package list
        if: >
          github.event.inputs.force_recurate == 'true' ||
          github.event_name == 'schedule' &&
          format('{0}', github.run_number) % 7 == '0'
        run: |
          python3 scripts/curate.py \
            --suite trixie \
            --arch amd64 \
            --output curated/packages.txt \
            --deps-output curated/deps.txt

      - name: Combine package lists
        run: |
          sort -u curated/packages.txt curated/deps.txt > curated/all.txt
          echo "Total packages: $(wc -l < curated/all.txt)"

      - name: Fetch, filter and sign indexes
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          mkdir -p dist_output

          SUITES=(forky trixie trixie-updates bookworm bookworm-updates bullseye bullseye-updates)
          ARCHES=(amd64 arm64 armhf i386 riscv64)
          RISCV_SUITES=(forky trixie trixie-updates)

          process_arch() {
            local suite=$1
            local arch=$2
            local outdir="dist_output/dists/$suite/main/binary-$arch"
            mkdir -p "$outdir"
            echo "Processing $suite/$arch..."

            local tmpfile
            tmpfile=$(mktemp /tmp/packages-XXXXXX)
            local fetched=0
            if curl -sf --retry 3 --retry-delay 5 -o "${tmpfile}.gz" \
                "https://deb.debian.org/debian/dists/$suite/main/binary-$arch/Packages.gz"; then
              mv "${tmpfile}.gz" "$tmpfile"
              fetched=1
            elif curl -sf --retry 3 --retry-delay 5 -o "${tmpfile}.xz" \
                "https://deb.debian.org/debian/dists/$suite/main/binary-$arch/Packages.xz"; then
              mv "${tmpfile}.xz" "$tmpfile"
              fetched=1
            fi
            if [[ $fetched -eq 1 ]]; then
              python3 scripts/filter.py \
                --input "$tmpfile" \
                --allowed curated/all.txt \
                --output "$outdir/Packages.gz" \
                --stats
            else
              echo "WARNING: Could not fetch $suite/$arch - skipping" >&2
            fi
            rm -f "$tmpfile"
          }

          for suite in "${SUITES[@]}"; do
            # binary-all
            process_arch "$suite" "all"

            for arch in "${ARCHES[@]}"; do
              if [[ "$arch" == "riscv64" && ! " ${RISCV_SUITES[*]} " =~ " $suite " ]]; then
                echo "Skipping $suite/$arch (riscv64 not available)"
                continue
              fi
              process_arch "$suite" "$arch"
            done

            bash scripts/sign.sh "dist_output/dists/$suite"
          done

      - name: Upload to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
        run: |
          python3 scripts/kv_upload.py \
            --dir dist_output \
            --account "$CF_ACCOUNT_ID" \
            --namespace "$CF_KV_NAMESPACE_ID" \
            --token "$CF_API_TOKEN"

      - name: Commit updated package list
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add curated/
          if git diff --staged --quiet; then
            echo "No changes to curated list"
          else
            git commit -m "chore: update curated package list [skip ci]"
            git push
          fi
